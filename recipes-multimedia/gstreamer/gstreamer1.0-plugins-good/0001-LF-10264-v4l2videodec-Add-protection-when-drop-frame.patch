From 345ab6036f68817e75ccae473c8fb37763cc18f2 Mon Sep 17 00:00:00 2001
From: Hou Qi <qi.hou@nxp.com>
Date: Mon, 16 Oct 2023 08:48:45 +0800
Subject: [PATCH] LF-10264 v4l2videodec: Add protection when drop frame

upstream status: pending
Part-of: <https://gitlab.freedesktop.org/gstreamer/gstreamer/-/merge_requests/5479>
---
 sys/v4l2/gstv4l2videodec.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/sys/v4l2/gstv4l2videodec.c b/sys/v4l2/gstv4l2videodec.c
index 79e36a046..7ac9fe0ce 100644
--- a/sys/v4l2/gstv4l2videodec.c
+++ b/sys/v4l2/gstv4l2videodec.c
@@ -1044,7 +1044,8 @@ gst_v4l2_video_dec_handle_frame (GstVideoDecoder * decoder,
     while (self->v4l2output->drop_frames) {
       guint32 *tmp = self->v4l2output->drop_frames->data;
       GstVideoFrame *frame = gst_video_decoder_get_frame (decoder, *tmp);
-      gst_video_decoder_drop_frame (decoder, frame);
+      if (frame)
+        gst_video_decoder_drop_frame (decoder, frame);
       self->v4l2output->drop_frames = g_list_remove (self->v4l2output->drop_frames, tmp);
     }
     GST_VIDEO_DECODER_STREAM_LOCK (decoder);
@@ -1102,7 +1103,8 @@ gst_v4l2_video_dec_handle_frame (GstVideoDecoder * decoder,
     while (self->v4l2output->drop_frames) {
       guint32 *tmp = self->v4l2output->drop_frames->data;
       GstVideoFrame *frame = gst_video_decoder_get_frame (decoder, *tmp);
-      gst_video_decoder_drop_frame (decoder, frame);
+      if (frame)
+        gst_video_decoder_drop_frame (decoder, frame);
       self->v4l2output->drop_frames = g_list_remove (self->v4l2output->drop_frames, tmp);
     }
     GST_VIDEO_DECODER_STREAM_LOCK (decoder);
-- 
2.17.0

